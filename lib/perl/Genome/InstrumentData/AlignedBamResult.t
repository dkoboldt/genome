#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
};

use strict;
use warnings;

use above 'Genome';

require File::Temp;
require Genome::Utility::Test;
use Test::More;

my $class = 'Genome::InstrumentData::AlignedBamResult';
use_ok($class) or die;
my $data_dir = Genome::Utility::Test->data_dir_ok($class);
my $input_bam = $data_dir.'/input.bam';
my $input_md5 = $input_bam.'.md5';
my $input_flagstat = $input_bam.'.flagstat';
class Genome::InstrumentData::AlignedBamResultTester {
    is => $class,
};

my $tmpdir = File::Temp::tempdir(CLEANUP => 1);
my $aligned_bam_result = Genome::InstrumentData::AlignedBamResultTester->__define__(
    id => -1337,
    output_dir => $tmpdir,
);
ok($aligned_bam_result, 'defined aligned bam result');

# bam
my $bam_path = $aligned_bam_result->bam_path;
is($bam_path, $tmpdir.'/'.$aligned_bam_result->id.'.bam', 'bam path named correctly');
is($aligned_bam_result->bam_file, $bam_path, 'bam file is same as bam path');
Genome::Sys->create_symlink($input_bam, $bam_path);
ok(-s $bam_path, 'linked bam');

# flagstat
my $flagstat_path = $aligned_bam_result->bam_flagstat_path;
ok(!-s $flagstat_path, 'flagstat does not exist yet');
is($flagstat_path, $aligned_bam_result->bam_path.'.flagstat', 'flagstat path named correctly');
is($aligned_bam_result->bam_flagstat_file, $flagstat_path, 'flagstat file is same as flagstat path');
ok($aligned_bam_result->run_flagstat_on_output_bam_path, 'run flagstat');
ok(-s $flagstat_path, 'created flagstat');
Genome::Utility::Test::compare_ok($flagstat_path, $input_flagstat);

# md5
my $md5_path = $aligned_bam_result->bam_md5_path;
ok(!-s $md5_path, 'md5 does not exist yet');
is($md5_path, $aligned_bam_result->bam_path.'.md5', 'md5 path named correctly');
my $md5sum = $aligned_bam_result->run_md5sum_on_output_bam_path;
ok($md5sum, 'run md5');
ok(-s $md5_path, 'created md5');
is($md5sum, '940825168285c254b58c47399a3e1173', 'run md5sum matches');
$md5sum = $aligned_bam_result->load_md5sum;
is($md5sum, '940825168285c254b58c47399a3e1173', 'load md5sum matches');

done_testing();
