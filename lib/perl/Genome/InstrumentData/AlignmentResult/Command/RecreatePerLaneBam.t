#!/usr/bin/env genome-perl

use strict;
use warnings FATAL => 'all';

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above "Genome";
use Test::More;
use Test::Exception;
use File::Copy;
use File::Basename;
use Genome::Utility::Test qw(compare_ok);

my $pkg = 'Genome::InstrumentData::AlignmentResult::Command::RecreatePerLaneBam';
use_ok($pkg) or die;

my $test_dir = Genome::Utility::Test->data_dir_ok($pkg, 'v3');
my $id       = 2894005341;
my $out_base = 'all_sequences.bam';
my $out_dir  = Genome::Sys->create_temp_directory();
my $out_bam  = File::Spec->join($out_dir, $out_base);

map{ok(copy($test_dir."/$out_base.$_", $out_dir),"$_ copied")}qw(header flagstat);

my %params = (
    merged_bam          => File::Spec->join($test_dir, 'test.bam'),
    instrument_data_id  => $id,
    per_lane_bam        => $out_bam,
    samtools_version    => 'r982',
    picard_version      => '1.82',
    bam_header          => File::Spec->join($out_dir, $out_base.'.header'),
    comparison_flagstat => File::Spec->join($out_dir, $out_base.'.flagstat'),
);

subtest 'testing command failure with invalid input' => sub {
    my %test_params = %params;
    $test_params{merged_bam}   = 'NO.BAM';
    $test_params{per_lane_bam} = 'FAKE.BAM';
    my $cmd = $pkg->create(%test_params);
    dies_ok(sub {$cmd->execute}, 'Invalid input bam');
};

subtest 'testing command failure with invalid samtools version' => sub {
    my %test_params = %params;
    $test_params{samtools_version} = 'r9888';
    my $cmd = $pkg->create(%test_params);
    ok(!$cmd->execute, 'Invalid samtools version');
};

subtest 'testing command failure with invalid picard version' => sub {
    my %test_params = %params;
    $test_params{picard_version} = '1.121111';
    my $cmd = $pkg->create(%test_params);
    ok(!$cmd->execute, 'Invalid picard version');
};

subtest 'testing command failure with invalid bam_header' => sub {
    my %test_params = %params;
    $test_params{bam_header} = 'NO_BAM_HEADER';
    my $cmd = $pkg->create(%test_params);
    dies_ok(sub {$cmd->execute}, 'Invalid bam_header');
};

subtest 'testing command failure with invalid bam_header' => sub {
    my %test_params = %params;
    $test_params{comparison_flagstat} = 'NO_COMPARISON_FLAGSTAT';
    my $cmd = $pkg->create(%test_params);
    dies_ok(sub {$cmd->execute}, 'Invalid comparison_flagstat');
};

subtest 'testing command' => sub {
    my $cmd = $pkg->create(%params);
    ok($cmd->execute, "Executed $pkg");

    for my $type ('', 'bai', 'md5') {
        my $out_name = $out_base;
        $out_name .= '.' .$type if $type;
        my $expected = File::Spec->join($test_dir, $out_name);
        my $test_out = File::Spec->join($out_dir, $out_name);
        compare_ok($expected, $test_out, "$out_name generated as expected");
    }
};

done_testing();

