#!/usr/bin/env genome-perl

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{UR_COMMAND_DUMP_STATUS_MESSAGES} = 1;
}

use strict;
use warnings;

use above "Genome";

use File::Temp;
use Test::More;

use_ok('Genome::Model::Tools::Sx::Trim::Flexbar') or die;

my $datadir = $ENV{GENOME_TEST_INPUTS}.'/Genome-Model-Tools-Sx/TrimFlexbar';
my $input1 = "$datadir/input_1.fastq";
ok(-s $input1, 'fastq input 1') or die;
my $input2 = "$datadir/input_2.fastq";
ok(-s $input2, 'fastq input 2') or die;

my $temp_dir = Genome::Sys->create_temp_directory;
my $cmd = Genome::Model::Tools::Sx::Trim::Flexbar->create(
    version => '229',
    input => [ $input1, $input2 ],
    output => [ "$temp_dir/output.fastq", ],
    adapter => 'gtttcccagtcacgata',
    adapter_gap_cost => -20,
    adapter_match => 3,
    adapter_min_overlap => 16,
    adapter_mismatch => -3,
    adapter_trim_end => 'ANY',
    max_uncalled => 100,
    no_length_dist => 1,
    remove_revcomp => 1, 
    threads => 4,
);
ok($cmd, "create flexbar to remove single adapter");
ok(eval{$cmd->execute}, "execute");
print "$@\n" if $@;
is_deeply($cmd->_cmds, ['/usr/bin/flexbar229 --adapter-gap-cost -20 --adapter-match 3 --adapter-min-overlap 16 --adapter-mismatch -3 --adapter-trim-end ANY --adapters '.$cmd->_tmpdir.'/adapters.fasta --max-uncalled 100 --threads 4 --no-length-dist --source '.$datadir.'/input_1.fastq --source2 '.$datadir.'/input_2.fastq --format fastq-sanger --target '.$cmd->_tmpdir.'/output.fastq'], 'flexbar command');

my @output = glob("$temp_dir/*fastq");
is(@output, 1, "got 1 fastq files");
is(Genome::Sys->md5sum($output[0]), '0bc803457a4343eaa555b99916d226c3', "Output fastq matches");

my $version = 230;
$datadir = $ENV{GENOME_TEST_INPUTS}.'/Genome-Model-Tools-Sx/TrimFlexbar'.$version;
$input1 = "$datadir/input_1.fastq";
ok(-s $input1, 'fastq input 1') or die;
$input2 = "$datadir/input_2.fastq";
ok(-s $input2, 'fastq input 2') or die;

$temp_dir = Genome::Sys->create_temp_directory;
$cmd = Genome::Model::Tools::Sx::Trim::Flexbar->create(
    version => $version,
    input => [ $input1, $input2 ],
    output => [ "$temp_dir/output.fastq", ],
    adapter => 'gtttcccagtcacgata',
    adapter_match => 3,
    adapter_min_overlap => 16,
    adapter_mismatch => -3,
    adapter_trim_end => 'ANY',
    max_uncalled => 100,
    remove_revcomp => 1, 
    threads => 4,
);
ok($cmd, "create flexbar to remove single adapter for v230");
ok(eval{$cmd->execute}, "execute");
print "$@\n" if $@;
is_deeply( $cmd->_cmds, ['LD_LIBRARY_PATH=/gscmnt/gc3001/assembly/Downloads/Flexbar_2.4/flexbar_v2.4_linux64 /gsc/bin/flexbar --adapter-match 3 --adapter-min-overlap 16 --adapter-mismatch -3 --adapter-trim-end ANY --adapters '.$cmd->_tmpdir.'/adapters.fasta --max-uncalled 100 --threads 4 --length-dist --reads '.$datadir.'/input_1.fastq --reads2 '.$datadir.'/input_2.fastq --format sanger --target '.$cmd->_tmpdir.'/output.fastq'], 'flexbar command');

@output = glob("$temp_dir/*fastq");
is(@output, 1, "got 1 fastq files");

my $md_sum = Genome::Sys->md5sum( $output[0] );
is( Genome::Sys->md5sum( $output[0] ), '88874bc2a76115d49589b2e5d58d3d9b', 'Output fastq matches' );

#print "gvimdiff $output[0] $GENOME_TEST_INPUTS/Genome-Model-Tools-Sx/TrimFlexbar/revcomp_adapter_removed.far2.17.fastq\n"; <STDIN>;
done_testing();
