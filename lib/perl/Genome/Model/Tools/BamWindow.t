#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
    $ENV{NO_LSF} = 1;
}

use above 'Genome';
use Test::More tests => 10;
use Genome::Utility::Test;
use File::Spec;
use File::Compare;

my $class = 'Genome::Model::Tools::BamWindow';
use_ok($class);

my $test_version = 3;
my $test_dir = File::Spec->join(Genome::Utility::Test->data_dir($class), "v$test_version");
ok(-e $test_dir, "Test directory $test_dir exists");

my $expected = File::Spec->join($test_dir, 'output.txt');
ok(-s $expected, "expected output file exists");

my $input_file = File::Spec->join($test_dir, 'input.bam');
ok(-s $input_file, "input bam exists");

my $output_file = Genome::Sys->create_temp_file_path;

my $cmd = Genome::Model::Tools::BamWindow->create(
    version => '0.5',
    bam_file => $input_file,
    output_file => $output_file,
    window_size => 10000,
    per_read_length => 1,
    per_library => 1,
    leftmost_only => 1,
    quality => 1,
);
ok($cmd, 'BamWindow command successfully created');
ok($cmd->execute, 'BamWindow successfully executed');
is(compare($output_file, $expected),0,"Actual file is the same as the expected file");

my $options_output_file = Genome::Sys->create_temp_file_path;

my $options_cmd = Genome::Model::Tools::BamWindow->create(
    version => '0.5',
    bam_file => $input_file,
    output_file => $options_output_file,
    options => '-w 10000 -r -l -s -q 1',
);

ok($options_cmd, 'BamWindow command with options string created successfully');
ok($options_cmd->execute, 'BamWindow with options executed successfully');
is(compare($options_output_file, $expected),0,"Actual file is the same as the expected file");
