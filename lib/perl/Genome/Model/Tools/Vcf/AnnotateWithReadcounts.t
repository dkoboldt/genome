#!/usr/bin/env genome-perl

BEGIN { 
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
}

use strict;
use warnings;

use above "Genome";
use Test::More;
use Genome::Utility::Test qw(compare_ok);
use Genome::File::Vcf::Differ;

my $pkg = 'Genome::Model::Tools::Vcf::AnnotateWithReadcounts';

use_ok($pkg);
my $data_dir = Genome::Utility::Test->data_dir_ok($pkg, "v5");

subtest "output vcf" => sub {
    my $out = Genome::Sys->create_temp_file_path;
    run($out);
    my $expected_out = File::Spec->join($data_dir, "expected.vcf");
    my $differ = Genome::File::Vcf::Differ->new($out, $expected_out);
    my $diff = $differ->diff;
    is($diff, undef, "Found No differences between $out and (expected) $expected_out") ||
       diag $diff->to_string;
};

subtest "duplicate vcf entries" => sub {
    my $out = Genome::Sys->create_temp_file_path;
    my $expected_out = File::Spec->join($data_dir, "duplicateVariants.expected.vcf");
    run($out, "duplicateVariants.vcf");
    my $differ = Genome::File::Vcf::Differ->new($out, $expected_out);
    my $diff = $differ->diff;
    is($diff, undef, "Found No differences between $out and (expected) $expected_out") ||
       diag $diff->to_string;
};

subtest "output gzipped vcf" => sub {
    my $out = Genome::Sys->create_temp_file_path . '.gz';
    run($out);

    my $expected_out = File::Spec->join($data_dir, "expected.vcf.gz");
    my $differ = Genome::File::Vcf::Differ->new($out, $expected_out);
    my $diff = $differ->diff;
    is($diff, undef, "Found No differences between $out and (expected) $expected_out") ||
       diag $diff->to_string;
};

subtest "output indel vcf" => sub {
    my $out = Genome::Sys->create_temp_file_path . '_indel.gz';
    run_indel($out);

    my $expected_out = File::Spec->join($data_dir, "expected_indel.vcf.gz");
    my $differ = Genome::File::Vcf::Differ->new($out, $expected_out);
    my $diff = $differ->diff;
    is($diff, undef, "Found No differences between $out and (expected) $expected_out") ||
       diag $diff->to_string;
};

subtest "insertion and deletion on same line" => sub {
    my $out = Genome::Sys->create_temp_file_path . '_indel2.gz';
    run_indel2($out);

    my $expected_out = File::Spec->join($data_dir, "expected_indel2.vcf.gz");
    my $differ = Genome::File::Vcf::Differ->new($out, $expected_out);
    my $diff = $differ->diff;
    is($diff, undef, "Found No differences between $out and (expected) $expected_out") ||
       diag $diff->to_string;
};

subtest "output vcf with new sample name" => sub {
    my $expected_out = File::Spec->join($data_dir, "expected_new_sample.vcf.gz");
    my $out = Genome::Sys->create_temp_file_path . '_new_sample.gz';
    run_new_sample($out);

    my $differ = Genome::File::Vcf::Differ->new($out, $expected_out);
    my $diff = $differ->diff;
    is($diff, undef, "Found No differences between $out and (expected) $expected_out") ||
       diag $diff->to_string;
};

done_testing;
sub run_new_sample {
    my $out = shift;

    my $cmd = $pkg->create(
        vcf_file => File::Spec->join($data_dir, "2.vcf.gz"),
        readcount_file_and_sample_name => [
            sprintf("%s:TEST-patient1-somval_normal", File::Spec->join($data_dir, 'test4.rc.tsv')),
        ],
        output_file => $out,
    );
    ok($cmd->isa($pkg), "Command created ok");
    ok($cmd->execute, "Command executed ok");
}

sub run_indel {
    my $out = shift;

    my $cmd = $pkg->create(
        vcf_file => File::Spec->join($data_dir, "2.vcf.gz"),
        readcount_file_and_sample_name => [
            sprintf("%s:TEST-patient1-somval_tumor1", File::Spec->join($data_dir, 'test3.rc.tsv')),
        ],
        output_file => $out,
    );
    ok($cmd->isa($pkg), "Command created ok");
    ok($cmd->execute, "Command executed ok");
}

sub run_indel2 {
    my $out = shift;

    my $cmd = $pkg->create(
        vcf_file => File::Spec->join($data_dir, "3.vcf.gz"),
        readcount_file_and_sample_name => [
            sprintf("%s:TEST-patient1-somval_tumor1", File::Spec->join($data_dir, 'test5.rc.tsv')),
        ],
        output_file => $out,
    );
    ok($cmd->isa($pkg), "Command created ok");
    ok($cmd->execute, "Command executed ok");
}

sub run {
    my $out = shift;
    my $in = shift;
    unless (defined $in) {
        $in = "1.vcf.gz";
    }

    my $cmd = $pkg->create(
        vcf_file => File::Spec->join($data_dir, $in),
        readcount_file_and_sample_name => [
            sprintf("%s:TEST-patient1-somval_tumor1", File::Spec->join($data_dir, 'test1.rc.tsv')),
            sprintf("%s:TEST-patient1-somval_normal1", File::Spec->join($data_dir, 'test2.rc.tsv')),
        ],
        output_file => $out,
    );
    ok($cmd->isa($pkg), "Command created ok");
    ok($cmd->execute, "Command executed ok");
}

