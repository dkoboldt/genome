#!/usr/bin/env genome-perl

use strict;
use warnings FATAL => 'all';

BEGIN {
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above "Genome";
use Test::More;
use Genome::Utility::Test qw(compare_ok);

my $pkg = 'Genome::Model::Tools::Sam::Readcount';
use_ok($pkg) or die;
my $test_data_dir = Genome::Utility::Test->data_dir_ok($pkg, '1');

my $output = Genome::Sys->create_temp_file_path;
my $expected = File::Spec->join($test_data_dir, 'expected');

my $reference = Genome::Model::Build::ImportedReferenceSequence->get_by_name('NCBI-human-build36');

my $cmd = $pkg->create(
    output_file => $output,
    bam_file => File::Spec->join($test_data_dir, 'tiny.bam'),
    region_list => File::Spec->join($test_data_dir, 'regions'),
    reference_fasta => $reference->full_consensus_path('fa'),
);

subtest 'testing command execution' => sub {
    ok($cmd->execute, "Executed $pkg");
    compare_ok($expected, $output, 'readcount file looks as expected');
};

subtest 'testing command strings' => sub {

    my %expected_command = (
        0.3 => '/usr/bin/bam-readcount0.3 /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/tiny.bam -f /gscmnt/gc4096/info/model_data/2741951221/build101947881/all_sequences.fa -l /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/regions 2> /dev/null',
        0.4 => '/usr/bin/bam-readcount0.4 /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/tiny.bam -f /gscmnt/gc4096/info/model_data/2741951221/build101947881/all_sequences.fa -l /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/regions 2> /dev/null',
        0.5 => '/usr/bin/bam-readcount0.5 /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/tiny.bam -f /gscmnt/gc4096/info/model_data/2741951221/build101947881/all_sequences.fa -l /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/regions -w 1',
        0.6 => '/usr/bin/bam-readcount0.6 /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/tiny.bam -f /gscmnt/gc4096/info/model_data/2741951221/build101947881/all_sequences.fa -l /gscmnt/gc13003/info/test_suite_data/Genome-Model-Tools-Sam-Readcount/1/regions -w 1',
    );

    for my $version (keys %expected_command) {
        $cmd->use_version($version);
        is($cmd->command, $expected_command{$version}, "The command string looks as expected for version $version");
    }
};

done_testing();

