#!/usr/bin/env genome-perl

use strict;
use warnings;

BEGIN{
    $ENV{UR_DBI_NO_COMMIT} = 1;
    $ENV{UR_USE_DUMMY_AUTOGENERATED_IDS} = 1;
};

use above "Genome";
use Test::More;
use File::Compare;
use Genome::Test::Factory::SoftwareResult::User;

if (Genome::Config->arch_os ne 'x86_64') {
    plan skip_all => 'requires 64-bit machine';
}
else {
    plan tests => 21;
}

use_ok('Genome::Model::Tools::DetectVariants2::Result::Vcf::Combine');


#TODO this could really use its own very tiny dataset--we don't care about the results in this test so much as the process
my $test_dir = $ENV{GENOME_TEST_INPUTS} . '/Genome-Model-Tools-DetectVariants2-Result-Vcf-Combine';
my $inputs = $test_dir."/inputs";

my $expected_dir = $test_dir."/expected.v8";

my $detector_union_expected_file = $expected_dir."/detector_test/union_snvs.vcf.gz";
my $filter_union_expected_file = $expected_dir."/filter_test/union_snvs.vcf.gz";
my $detector_intersect_expected_file = $expected_dir."/detector_test/intersect_snvs.vcf.gz";
my $filter_intersect_expected_file = $expected_dir."/filter_test/intersect_snvs.vcf.gz";
my $combine_union_expected_file = $expected_dir."/combine_test/union_snvs.vcf.gz";
my $combine_intersect_expected_file = $expected_dir."/combine_test/intersect_snvs.vcf.gz";

my $varscan_detector_directory = $inputs."/varscan";
my $varscan_detector_vcf_directory = $inputs."/varscan_vcf_result";
my $samtools_detector_directory = $inputs."/samtools";
my $samtools_detector_vcf_directory = $inputs."/samtools_vcf_result";

my $snp_filter_directory = $inputs."/snp_filter_result";
my $snp_filter_vcf_directory = $inputs."/snp_filter_vcf_result";
my $false_positive_filter_directory = $inputs."/false_positive_filter_result";
my $false_positive_filter_vcf_directory = $inputs."/false_positive_filter_vcf_result";
my $intersect_directory = $inputs."/intersect_result";
my $union_directory = $inputs."/union_result";
my $intersect_vcf_directory = $inputs."/intersect_vcf_result";
my $union_vcf_directory = $inputs."/union_vcf_result";

my $bam_file = $test_dir . '/alignments/102922275_merged_rmdup.bam';


my $refbuild_id = 101947881;

my $result_users = Genome::Test::Factory::SoftwareResult::User->setup_user_hash(
    reference_sequence_build_id => $refbuild_id,
);

my $varscan_version = '2.2.9';
my $samtools_version = 'r599';

my $detector_parameters = '';
my $vcf_version = Genome::Model::Tools::Vcf->get_vcf_version;



# Detector and Detector VCF results

my $varscan_detector_result = Genome::Model::Tools::DetectVariants2::Result->__define__(
    output_dir => $varscan_detector_directory,
    detector_name => 'Genome::Model::Tools::DetectVariants2::VarscanSomatic',
    detector_params => '',
    detector_version => $varscan_version,
    aligned_reads => $bam_file,
    reference_build_id => $refbuild_id,
);
$varscan_detector_result->lookup_hash($varscan_detector_result->calculate_lookup_hash);

my $varscan_detector_vcf_result = Genome::Model::Tools::DetectVariants2::Result::Vcf::Detector->__define__(
    input => $varscan_detector_result,
    output_dir => $varscan_detector_vcf_directory,
    aligned_reads_sample => "TEST",
    vcf_version => $vcf_version,
);
$varscan_detector_vcf_result->lookup_hash($varscan_detector_vcf_result->calculate_lookup_hash);

$varscan_detector_result->add_user(user => $varscan_detector_vcf_result, label => 'uses');

my $samtools_detector_result = Genome::Model::Tools::DetectVariants2::Result->__define__(
    output_dir => $samtools_detector_directory,
    detector_name => 'Genome::Model::Tools::DetectVariants2::Samtools',
    detector_params => '',
    detector_version => $samtools_version,
    aligned_reads => $bam_file,
    reference_build_id => $refbuild_id,
);
$samtools_detector_result->lookup_hash($samtools_detector_result->calculate_lookup_hash);

my $samtools_detector_vcf_result = Genome::Model::Tools::DetectVariants2::Result::Vcf::Detector->__define__(
    input => $samtools_detector_result,
    output_dir => $samtools_detector_vcf_directory,
    aligned_reads_sample => "TEST",
    vcf_version => $vcf_version,
);
$samtools_detector_vcf_result->lookup_hash($samtools_detector_vcf_result->calculate_lookup_hash);

$samtools_detector_result->add_user(user => $samtools_detector_vcf_result, label => 'uses');


# Filter and Filter VCF result

my $snp_filter_result = Genome::Model::Tools::DetectVariants2::Result::Filter->__define__(
    output_dir => $snp_filter_directory,
    detector_name => 'Genome::Model::Tools::DetectVariants2::Samtools',
    detector_params => '',
    detector_version => $samtools_version,
    aligned_reads => $bam_file,
    reference_build_id => $refbuild_id,
    filter_name => 'Genome::Model::Tools::DetectVariants2::Filter::SnpFilter',
    filter_params => '',
    filter_version => 'v1',
);
$snp_filter_result->lookup_hash($snp_filter_result->calculate_lookup_hash);

my $snp_filter_vcf_result = Genome::Model::Tools::DetectVariants2::Result::Vcf::Filter->__define__(
    filter_name => 'Genome::Model::Tools::DetectVariants2::Filter::SnpFilter',
    filter_params => '',
    filter_version => 'v1',
    incoming_vcf_result => $varscan_detector_vcf_result,
    input => $snp_filter_result,
    output_dir => $snp_filter_vcf_directory,
    aligned_reads_sample => "TEST",
    vcf_version => $vcf_version,
);
$snp_filter_vcf_result->lookup_hash($snp_filter_vcf_result->calculate_lookup_hash);

$snp_filter_result->add_user(user => $snp_filter_vcf_result, label => 'uses');

my $false_positive_filter_result = Genome::Model::Tools::DetectVariants2::Result::Filter->__define__(
    output_dir => $false_positive_filter_directory,
    detector_name => 'Genome::Model::Tools::DetectVariants2::VarscanSomatic',
    detector_params => '',
    detector_version => $varscan_version,
    aligned_reads => $bam_file,
    reference_build_id => $refbuild_id,
    filter_name => 'Genome::Model::Tools::DetectVariants2::Filter::FalsePositive',
    filter_params => '',
    filter_version => 'v1',
);
$false_positive_filter_result->lookup_hash($false_positive_filter_result->calculate_lookup_hash);

my $false_positive_filter_vcf_result = Genome::Model::Tools::DetectVariants2::Result::Vcf::Filter->__define__(
    filter_name => 'Genome::Model::Tools::DetectVariants2::Filter::FalsePositive',
    filter_params => '',
    filter_version => 'v1',
    incoming_vcf_result => $samtools_detector_vcf_result,
    input => $false_positive_filter_result,
    output_dir => $false_positive_filter_vcf_directory,
    aligned_reads_sample => "TEST",
    vcf_version => $vcf_version,
);
$false_positive_filter_vcf_result->lookup_hash($false_positive_filter_vcf_result->calculate_lookup_hash);

$false_positive_filter_result->add_user(user => $false_positive_filter_vcf_result, label => 'uses');

my $union_result = Genome::Model::Tools::DetectVariants2::Result::Combine::UnionSnv->__define__(
    input_a => $snp_filter_result,
    input_b => $false_positive_filter_result,
    output_dir => $union_directory,
    version => 42,
);
$union_result->lookup_hash($union_result->calculate_lookup_hash);

my $union_vcf_result = Genome::Model::Tools::DetectVariants2::Result::Vcf::Combine->__define__(
    incoming_vcf_result_a => $snp_filter_vcf_result,
    incoming_vcf_result_b => $false_positive_filter_vcf_result,
    input_a_id => $snp_filter_result->id,
    input_b_id => $false_positive_filter_result->id,
    input => $union_result,
    output_dir => $union_vcf_directory,
    variant_type => "snvs",
    joinx_version => 1.9,
    vcf_version => $vcf_version,
);
$union_vcf_result->lookup_hash($union_vcf_result->calculate_lookup_hash);

$union_result->add_user(user => $union_vcf_result, label => 'uses');

my $intersect_result = Genome::Model::Tools::DetectVariants2::Result::Combine::IntersectSnv->__define__(
    input_a => $snp_filter_result,
    input_b => $false_positive_filter_result,
    output_dir => $intersect_directory,
    version => 42,
);
$intersect_result->lookup_hash($intersect_result->calculate_lookup_hash);

my $intersect_vcf_result = Genome::Model::Tools::DetectVariants2::Result::Vcf::Combine->__define__(
    incoming_vcf_result_a => $snp_filter_vcf_result,
    incoming_vcf_result_b => $false_positive_filter_vcf_result,
    input_a_id => $snp_filter_result->id,
    input_b_id => $false_positive_filter_result->id,
    input => $intersect_result,
    output_dir => $intersect_vcf_directory,
    variant_type => "snvs",
    joinx_version => 1.9,
    vcf_version => $vcf_version,
);
$intersect_vcf_result->lookup_hash($intersect_vcf_result->calculate_lookup_hash);

$intersect_result->add_user(user => $intersect_vcf_result, label => 'uses');

$varscan_detector_result->add_user(user => $snp_filter_result, label => 'uses');
$samtools_detector_result->add_user(user => $false_positive_filter_result, label => 'uses');

#Test combining detector results with union
run_combine_test($samtools_detector_result,$varscan_detector_result, $detector_union_expected_file, "Union", $result_users);

#Test combining filter results with union
run_combine_test($snp_filter_result,$false_positive_filter_result, $filter_union_expected_file, "Union", $result_users);

#Test combining detector results with intersection
# FIXME for now, do not test this because joinx doesnt like it that the input VCFs do not have a FORMAT tag for FT (unfiltered thus far)
#run_combine_test($samtools_detector_result,$varscan_detector_result, $detector_intersect_expected_file, "Intersect", $result_users);

#Test combining filter results with intersection
run_combine_test($snp_filter_result,$false_positive_filter_result, $filter_intersect_expected_file, "Intersect", $result_users);

# Test combining a union and intersection result with a union
run_combine_test($intersect_result, $union_result, $combine_union_expected_file, "Union", $result_users);

sub run_combine_test {
    my $result_a = shift;
    my $result_b = shift;
    my $expected_file = shift;
    my $operation = shift;

    my $result_users = shift;

    my $test_working_dir = File::Temp::tempdir('DetectVariants2-Result-Vcf-CombineXXXXX', CLEANUP => 1, TMPDIR => 1);

    my %command_params = (
        input_a_id => $result_a->id,
        input_b_id => $result_b->id,
        output_directory => $test_working_dir,
        aligned_reads_sample => "TEST",
        result_users => $result_users,
    );

    my $command_type = "Genome::Model::Tools::DetectVariants2::Combine::" . $operation . "Snv";
    my $command = $command_type->create(%command_params);

    isa_ok($command, "$command_type", "created $command_type operation");
    ok($command->execute, "executed $command_type command");

    my $combine_vcf_result = $command->_vcf_result;
    isa_ok($combine_vcf_result, 'Genome::Model::Tools::DetectVariants2::Result::Vcf::Combine','created a combine_vcf_result');
    my @errors = $combine_vcf_result->__errors__;
    ok(!@errors, 'no errors on combine vcf result');

    my $output_file = $combine_vcf_result->output_dir."/snvs.vcf.gz";
    
    my $expected = `zcat $expected_file | grep -v fileDate`;
    my $output = `zcat $output_file | grep -v fileDate`;

    my $diff = Genome::Sys->diff_text_vs_text($output, $expected);
    ok(!$diff, 'output matched expected result')
        or diag("diff results:\n" . $diff);
}
